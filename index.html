<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Offer Builder & Data Comparison - Multi-Round</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.7.107/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>

    <style>
        /* Base and Layout */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #eef2f5; padding: 0; margin: 0; }
        .container { max-width: 1350px; margin: 20px auto; padding: 0 1rem; }
        .header { background-color: #0b1a3d; padding: 25px; color: white; border-radius: 12px 12px 0 0; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .header h1 { font-size: 2.8em; font-weight: 800; color: #4299e1; }
        .header p { color: #a0aec0; }
        
        /* Card and Section Styling */
        .card { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 6px 15px rgba(0,0,0,0.08); margin-bottom: 25px; border-top: 4px solid #4299e1; transition: all 0.3s ease; }
        .card-round-1 { border-top-color: #38a169; }
        .card-round-2 { border-top-color: #ed8936; }
        .data-card { 
            background: #fff; 
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); 
            transition: transform 0.2s; 
            margin-bottom: 20px;
        }
        .data-card:hover { transform: translateY(-4px); box-shadow: 0 8px 20px rgba(0,0,0,0.1); }

        /* Buttons */
        .btn { padding: 10px 18px; border-radius: 6px; cursor: pointer; font-weight: 600; border: none; transition: background-color 0.2s; }
        .btn.primary { background: #4299e1; color: white; }
        .btn.primary:hover { background: #3182ce; }
        .btn.ghost { background: white; color: #4299e1; border: 1px solid #4299e1; }
        .btn.ghost:hover { background: #ebf8ff; }

        /* Editable Elements */
        [contenteditable="true"], .term-select, .term-textarea { 
            border: 1px dashed #a0aec0; 
            padding: 4px 6px; 
            outline: none; 
            width: 100%; 
            border-radius: 4px; 
            transition: border-color 0.2s;
        }
        [contenteditable="true"]:focus, .term-select:focus, .term-textarea:focus { border-color: #4299e1; background-color: #f7fafc; }
        .term-select { display: inline-block; width: auto; border: 1px solid #ccc; }
        .term-textarea { min-height: 80px; resize: vertical; }
        
        /* Item Row Styling */
        .item-row { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 6px 0; 
            border-bottom: 1px dashed #ebf8ff; /* Light, subtle separator */
            gap: 10px;
        }
        .item-description-container {
            display: flex;
            align-items: center;
            flex-grow: 1;
        }
        .arabic-text {
            border-left: 3px solid #f6e05e; /* Yellow highlight for Arabic text */
            padding-left: 8px;
            font-family: 'Arial', 'Tahoma', 'Times New Roman', serif;
        }
        .item-row > span:nth-child(2), .item-row > span:nth-child(3) { width: 90px; text-align: right; font-weight: 500; }
        .item-row > button { width: 20px; flex-shrink: 0; } 

        /* File List and Search Inputs */
        .file-entry { 
            background: #f7fafc; 
            margin-bottom: 10px; 
            padding: 10px; 
            border: 1px solid #e2e8f0; 
            border-radius: 6px;
        }
        .file-name { font-weight: 700; font-size: 0.95em; color: #2d3748; margin-bottom: 5px; }
        .search-input { padding: 6px; border: 1px solid #ccc; border-radius: 4px; font-size: 0.8em; }
        .file-inputs { display: flex; gap: 5px; margin-top: 5px; }
        .file-inputs > input { flex-grow: 1; }
        .file-inputs > input.row-input { width: 50px; flex-grow: 0; }
        
        /* Savings Table Style */
        .savings-table { 
            border-collapse: collapse; 
            width: 100%; 
            margin-top: 15px;
        }
        .savings-table th, .savings-table td {
            border: 1px solid #e2e8f0;
            padding: 12px 15px;
            text-align: left;
            font-size: 0.95em;
        }
        .savings-table th {
            background-color: #4299e1;
            color: white;
            font-weight: 700;
        }
        .savings-table tbody td {
            background-color: #ffffff;
        }
        .savings-table tbody td[contenteditable="true"] {
             border: 1px dashed #a0aec0; 
        }
    </style>
</head>

<body>
<div class="container">

    <header class="header">
        <h1>Procurement Offer Comparison Tool</h1>
        <p class="subtitle">Structured analysis for multi-round negotiations and savings tracking.</p>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

        <section class="lg:col-span-1">
            
            <div class="card card-round-1">
                <label class="block text-xl font-bold mb-3 text-gray-800">1. Initial Offers (Round 1)</label>
                
                <label class="block font-semibold mt-2">Project/Offer Title</label>
                <input id="offerTitle" type="text" placeholder="e.g., Q4 Pump Supply Tender" class="w-full mb-4 p-2 border rounded" />

                <label class="block font-semibold mt-2">Attach Files (PDF/Excel)</label>
                <input type="file" id="filesInput" multiple accept=".pdf,.xlsx,.xls,.png,.jpg,.jpeg" class="w-full mt-2 mb-2" />
                
                <h3 class="font-semibold text-sm mt-3 mb-2 text-gray-600">Round 1 Attachments:</h3>
                <div id="attachmentListRound1" class="mt-3"></div> 

                <div class="flex gap-3 mt-5">
                    <button id="compareBtnRound1" class="btn primary" onclick="loadExtractedData(1)">Extract Round 1 Data</button>
                </div>
            </div>

            <div class="card card-round-2">
                <label class="block text-xl font-bold mb-3 text-gray-800">2. Negotiated Offers (Round 2)</label>
                
                <label class="block font-semibold mt-2">Attach Files (Lower Prices)</label>
                <input type="file" id="filesInputRound2" multiple accept=".pdf,.xlsx,.xls,.png,.jpg,.jpeg" class="w-full mt-2 mb-2" />
                
                <h3 class="font-semibold text-sm mt-3 mb-2 text-gray-600">Round 2 Attachments:</h3>
                <div id="attachmentListRound2" class="mt-3"></div> 

                <div class="flex gap-3 mt-5">
                    <button id="compareBtnRound2" class="btn ghost" onclick="loadExtractedData(2)" disabled>Extract Round 2 Data</button>
                </div>
            </div>

             <div class="card border-t-4 border-gray-400">
                <h3 class="text-xl font-bold mb-3 text-gray-800">3. Generate Report</h3>
                <button id="generateBtn" class="btn primary w-full" onclick="downloadExcel()">
                    <span class="mr-2">‚¨áÔ∏è</span> Download Final Excel Report
                </button>
            </div>

        </section>

        <section class="lg:col-span-2">
            
            <div id="initialPrompt" class="bg-white p-10 rounded-xl shadow-lg text-center mb-10 border-t-4 border-yellow-500">
                <h3 class="text-2xl font-semibold text-gray-700 mb-4">Start Comparison</h3>
                <p class="text-gray-500">Upload your initial PDF/Excel offers in the **Round 1** section and click **Extract Data** to begin the process.</p>
            </div>

            <h3 class="text-2xl font-bold text-gray-700 mt-8 mb-4 border-b-2 border-green-500 pb-2" id="round1Title" style="display:none;">Initial Offers (Round 1)</h3>
            <div id="offersContainerRound1" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>

            <h3 class="text-2xl font-bold text-gray-700 mt-10 mb-4 border-b-2 border-orange-500 pb-2" id="round2Title" style="display:none;">Negotiated Offers (Round 2)</h3>
            <div id="offersContainerRound2" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>

            <h3 class="text-2xl font-bold text-gray-700 mt-10 mb-4 border-b-2 border-blue-500 pb-2">Source Savings & Cost Avoidance Tracking</h3>
            <div class="card p-0 shadow-lg">
                <table id="savingsTable" class="savings-table w-full bg-white rounded-lg overflow-hidden">
                    <thead>
                        <tr>
                            <th>Category</th>
                            <th>Savings Type</th>
                            <th class="w-1/6">Value (EGP)</th>
                            <th>Notes</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td contenteditable="true">Initial Negotiation</td>
                            <td contenteditable="true">Source Savings</td>
                            <td contenteditable="true" class="text-right">0.00</td>
                            <td contenteditable="true">Difference between Round 1 vs Round 2 lowest bids.</td>
                        </tr>
                        <tr>
                            <td contenteditable="true">Switching Supplier</td>
                            <td contenteditable="true">Cost Avoidance</td>
                            <td contenteditable="true" class="text-right">0.00</td>
                            <td contenteditable="true">Savings against the incumbent supplier's original price.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>
    </div>

</div>

<script> 
/*** GLOBAL DATA ***/
let offersData = {
    round1Offers: [],
    round2Offers: []
};
let attachedFiles = {
    round1: [],
    round2: []
};

/*** Constants ***/
const PAYMENT_OPTIONS = ['30 days net', '60 days net', '90 days net'];
const DELIVERY_OPTIONS = ['DDP Site', 'EXW Factory', 'CIF Port', 'CIP Carrier'];
const MAX_UNIT_PRICE = 20000000; 

/*** pdf.js worker setup ***/
if (typeof pdfjsLib !== 'undefined') {
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.7.107/pdf.worker.min.js';
}

/*** Helpers ***/
const isArabic = (text) => {
    if (!text) return false;
    const arabicRegex = /[\u0600-\u06FF]/; 
    const arabicCharCount = (text.match(arabicRegex) || []).length;
    return arabicCharCount >= 2;
};

window.copyTextToClipboard = async (text, btnElement) => {
    try {
        await navigator.clipboard.writeText(text);
        const originalText = btnElement.textContent;
        btnElement.textContent = '‚úÖ Copied!';
        setTimeout(() => {
            btnElement.textContent = originalText;
        }, 1500);
    } catch (err) {
        console.error('Failed to copy text: ', err);
        alert('Could not copy text to clipboard. Please copy manually.');
    }
};

const formatCurrency = (num) => {
    const number = Number(num);
    if (isNaN(number)) return "0.00 EGP";
    return new Intl.NumberFormat("en-US", { style: "currency", currency: "EGP", minimumFractionDigits: 2 }).format(number);
};

const parseFlexibleCurrency = (text) => {
    if (!text) return 0;
    const cleaned = String(text).replace(/[^\d,.\-]/g, '').trim();
    if (cleaned === '') return 0;
    const parts = cleaned.split(/[\s]/).join('');
    const lastCommaIndex = parts.lastIndexOf(',');
    const lastDotIndex = parts.lastIndexOf('.');
    let normalized = parts;
    if (lastCommaIndex > -1 && lastCommaIndex > lastDotIndex) {
        if (parts.match(/,\d{1,2}$/) && !parts.match(/\.\d+$/)) {
            normalized = parts.replace(/,/g, '.');
        } else {
            normalized = parts.replace(/,/g, '');
        }
    } else {
        normalized = parts.replace(/,/g, '');
    }
    const number = parseFloat(normalized);
    return isNaN(number) ? 0 : number;
};

const containsLetters = (s) => /[A-Za-z\u0600-\u06FF]/.test(s);

const cleanTextForSearch = (text) => {
    if (!text) return '';
    return String(text)
        .toLowerCase()
        .replace(/[^a-z0-9\s\u0600-\u06FF]/g, '') 
        .trim()
        .replace(/\s+/g, ' ');
};

const filterExtractedRows = (rows, searchTerm) => {
    if (!searchTerm || searchTerm.trim() === '') return rows;
    
    const cleanSearchTerm = cleanTextForSearch(searchTerm);
    if (cleanSearchTerm.length === 0) return rows;
    
    const filtered = rows.filter(row => {
        const cleanDescription = cleanTextForSearch(row.description);
        
        if (cleanDescription.includes(cleanSearchTerm)) return true;

        const searchTokens = cleanSearchTerm.split(' ').filter(token => token.length > 0);
        if (searchTokens.length > 1) {
            const allTokensFound = searchTokens.every(token => cleanDescription.includes(token));
            if (allTokensFound) return true;
        }

        return false;
    });

    return filtered;
};


/*** PDF Extraction (Original Logic - not changed as per strict instructions) ***/
async function extractDataFromPDF(file, searchTerm = '') {
    const reader = new FileReader();

    return new Promise((resolve, reject) => {
        reader.onload = async function () {
            try {
                const typedArray = new Uint8Array(this.result);
                const pdf = await pdfjsLib.getDocument(typedArray).promise;

                let rowsOut = [];

                for (let p = 1; p <= pdf.numPages; p++) {
                    const page = await pdf.getPage(p);
                    const viewport = page.getViewport({ scale: 1 });
                    const content = await page.getTextContent();

                    const blocks = content.items.map(i => ({
                        text: i.str.trim(),
                        x: i.transform[4],
                        y: Math.floor(i.transform[5] / 3),
                        rawY: i.transform[5]
                    })).filter(b => b.text.length > 0);

                    if (blocks.length === 0) continue;

                    const rowMap = {};
                    const threshold = 6; 

                    for (let b of blocks) {
                        let key = Object.keys(rowMap).find(k => Math.abs(Number(k) - b.y) < threshold);
                        if (!key) key = b.y;
                        if (!rowMap[key]) rowMap[key] = [];
                        rowMap[key].push(b);
                    }

                    const rows = Object.values(rowMap).map(r => r.sort((a,b)=>a.x-b.x));

                    for (let row of rows) {
                        if (row.length < 2) continue;
                        const joined = row.map(r => r.text).join(" ").trim();
                        if (/^(item|description|unit|qty|quantity|price|amount|value|total|subtotal|grand total|offer|quotation|supplier)/i.test(joined)) continue;
                        if (!containsLetters(joined) || !/\d/.test(joined)) continue;

                        const nums = row.filter(r => /\d/.test(r.text));
                        if (nums.length === 0) continue;
                        
                        const rightEdgeThreshold = viewport.width * 0.6; 
                        const priceCandidates = nums.filter(n => n.x > rightEdgeThreshold).sort((a,b)=>b.x-a.x); 
                        
                        let priceBlock = null;
                        let priceValue = 0;

                        for (const candidate of priceCandidates) {
                            const val = parseFlexibleCurrency(candidate.text);
                            if (val > 0 && val <= MAX_UNIT_PRICE) {
                                priceBlock = candidate;
                                priceValue = val;
                                break; 
                            }
                        }

                        if (!priceBlock && priceCandidates.length > 0) {
                             priceBlock = priceCandidates[0]; 
                             priceValue = parseFlexibleCurrency(priceBlock.text);
                        }

                        if (priceValue <= 0) continue; 

                        const descBlocks = row.filter(r => r.x < priceBlock.x);
                        const desc = descBlocks.map(r => r.text).join(" ").trim();
                        if (desc.length < 5 || descBlocks.length === 0 || desc.split(' ').length < 2) continue; 
                        
                        rowsOut.push({
                            description: desc,
                            price: priceValue
                        });
                    }
                }
                
                if (searchTerm) {
                    const filteredRows = filterExtractedRows(rowsOut, searchTerm);
                    if (filteredRows.length === 0) {
                        return resolve([{ description: `No items found matching: "${searchTerm}". Try simplifying your search term.`, price: 0 }]);
                    }
                    return resolve(filteredRows);
                } else {
                    return resolve(rowsOut); 
                }

            } catch (err) {
                console.error("PDF Extraction Error:", err);
                reject([{ description: `Error during PDF extraction for this file.`, price: 0 }]);
            }
        };

        reader.onerror = reject;
        reader.readAsArrayBuffer(file);
    });
}

/*** Excel reader (Original Logic - not changed as per strict instructions) ***/
async function extractDataFromExcel(file, startingRow = 1, searchTerm = '') {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheetName = workbook.SheetNames[0];
                const sheet = workbook.Sheets[firstSheetName];
                
                const json = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: '' }); 
                
                const startRowIndex = Math.max(0, (startingRow || 1) - 1);
                
                const rows = [];
                for (let i = startRowIndex; i < json.length; i++) {
                    const row = json[i];
                    const joined = row.join(' ').trim();
                    if (!joined) continue;

                    const lastNumMatch = Array.from(joined.matchAll(/(\d{1,3}(?:[,\s]\d{3})*(?:\.\d+)?|\d+(?:\.\d+)?)/g)).pop();
                    const price = lastNumMatch ? parseFlexibleCurrency(lastNumMatch[0]) : 0;
                    const desc = price ? joined.replace(lastNumMatch[0],'').trim() : joined;
                    
                    if (price && containsLetters(desc)) rows.push({ description: desc, price });
                }
                
                if (searchTerm) {
                    const filteredRows = filterExtractedRows(rows, searchTerm);
                     if (filteredRows.length === 0) {
                        return resolve([{ description: `No items found matching: "${searchTerm}". Try simplifying your search term.`, price: 0 }]);
                    }
                    return resolve(filteredRows);
                }

                resolve(rows);
            } catch (err) { reject(err); }
        };
        reader.onerror = (err) => reject(err);
        reader.readAsArrayBuffer(file);
    });
}


/*** File List Management (Original Logic - not changed as per strict instructions) ***/

document.getElementById("filesInput").addEventListener("change", (e) => {
    attachedFiles.round1 = Array.from(e.target.files).map((file, index) => ({
        file: file,
        id: `r1_file_${index}`,
        searchTerm: '',
        startingRow: 1 
    }));
    renderAttachmentList(1);
});

document.getElementById("filesInputRound2").addEventListener("change", (e) => {
    attachedFiles.round2 = Array.from(e.target.files).map((file, index) => ({
        file: file,
        id: `r2_file_${index}`,
        searchTerm: '',
        startingRow: 1 
    }));
    document.getElementById('compareBtnRound2').disabled = (attachedFiles.round2.length === 0);
    renderAttachmentList(2);
});

const getFileById = (id, round) => attachedFiles[`round${round}`].find(f => f.id === id);

const handleSearchTermChange = (event, fileId, round) => {
    const fileEntry = getFileById(fileId, round);
    if (fileEntry) { fileEntry.searchTerm = event.target.value; }
};

const handleStartingRowChange = (event, fileId, round) => {
    const fileEntry = getFileById(fileId, round);
    if (fileEntry) {
        const row = parseInt(event.target.value) || 1;
        fileEntry.startingRow = Math.max(1, row);
        event.target.value = fileEntry.startingRow;
    }
};

const renderAttachmentList = (round) => {
    const listContainer = document.getElementById(`attachmentListRound${round}`);
    listContainer.innerHTML = attachedFiles[`round${round}`].map(fileEntry => {
        const isExcel = /\.(xlsx|xls)$/i.test(fileEntry.file.name);
        return `
            <div class="file-entry" id="${fileEntry.id}">
                <div class="file-name">${fileEntry.file.name}</div>
                <div class="file-inputs">
                    <input 
                        type="text" 
                        class="search-input" 
                        placeholder="Specific item to extract (filter)" 
                        value="${fileEntry.searchTerm}"
                        oninput="handleSearchTermChange(event, '${fileEntry.id}', ${round})"
                    />
                    ${isExcel ? `
                        <input 
                            type="number" 
                            class="search-input row-input" 
                            placeholder="Row"
                            value="${fileEntry.startingRow}"
                            onchange="handleStartingRowChange(event, '${fileEntry.id}', ${round})"
                            min="1"
                            title="Excel starting row number for data"
                        />
                    ` : ''}
                </div>
            </div>
        `;
    }).join('');
};


/*** Generate Offer object (Original Logic - not changed as per strict instructions) ***/
const generateOfferFromFile = (fileObj, index, extractedRows, round) => {
    const validRows = extractedRows.filter(r => r.price > 0);
    const rows = validRows.length > 0 ? validRows : [{ description: 'No valid item rows extracted', price: 0 }];
    
    let grandTotal = 0;
    const items = rows.map((r, i) => {
        const qty = 1; 
        const unit = Number(r.price) || 0;
        const subtotal = unit * qty;
        grandTotal += subtotal;
        return { description: r.description || '', unitPrice: unit, quantity: qty, subtotalPrice: subtotal };
    });

    return {
        id: `${round}_${index}`,
        supplier: fileObj.file.name,
        fileName: fileObj.file.name,
        address: fileObj.searchTerm ? `Extraction Filter: "${fileObj.searchTerm}"` : `Extracted data from file ${index + 1}`,
        items: items,
        totalPrice: grandTotal,
        terms: { payment: PAYMENT_OPTIONS[Math.floor(Math.random() * PAYMENT_OPTIONS.length)], delivery: DELIVERY_OPTIONS[Math.floor(Math.random() * DELIVERY_OPTIONS.length)], notes: `Auto-extracted: ${items.length} line(s).` }
    };
};

/*** UI / rendering (Original Logic - not changed as per strict instructions) ***/
const createSelectOptions = (options, selectedValue) => options.map(option => `<option value="${option}" ${option===selectedValue?'selected':''}>${option}</option>`).join('');

const renderOfferCard = (offer, round) => {
    
    const itemsList = offer.items.map((i, idx) => {
        const isDescArabic = isArabic(i.description);
        const descriptionClass = isDescArabic ? 'arabic-text' : '';

        return `
            <li class="item-row text-sm py-2">
                <div class="item-description-container">
                    <span 
                        contenteditable="true" 
                        class="text-left ${descriptionClass}" 
                        onblur="handleItemDescriptionChange(event, '${offer.id}', ${idx}, ${round})"
                        style="${isDescArabic ? 'direction: rtl; text-align: right; flex-grow: 1;' : 'direction: ltr; text-align: left; flex-grow: 1;'}"
                    >${i.description || ''}</span>
                    ${isDescArabic ? `<button 
                        class="copy-btn" 
                        onclick="copyTextToClipboard('${i.description.replace(/'/g, "\\'")}', this)" 
                        title="Copy Arabic text for translation"
                    >üîó</button>` : ''}
                </div>
                <span contenteditable="false" class="text-gray-600 text-xs">${formatCurrency(i.unitPrice)}</span>
                <span id="item-subtotal-${offer.id}-${idx}" contenteditable="true" onblur="handlePriceChange(event, '${offer.id}', ${idx}, ${round})" class="font-bold text-sm text-blue-800">${formatCurrency(i.subtotalPrice)}</span>
                <button onclick="deleteRow('${offer.id}', ${idx}, ${round})" class="text-red-500 hover:text-red-700 p-0 m-0 leading-none h-4 w-4 text-xs font-bold" title="Delete Row">‚úï</button>
            </li>
        `;
    }).join('');

    const currentOffers = offersData[`round${round}Offers`];
    const lowest = currentOffers.length ? Math.min(...currentOffers.map(o=>o.totalPrice)) : Infinity;
    const isLowest = offer.totalPrice === lowest && currentOffers.length > 0;
    const lowestClass = isLowest ? "border-green-500 bg-green-50" : "border-blue-500 bg-gray-50";

    return `
        <div class="data-card border-t-4 ${lowestClass}">
            <h2 class="text-lg font-bold mb-1">${offer.supplier}</h2>
            <p class="text-xs text-gray-500 mb-3">${offer.address}</p>
            <div class="text-center mb-4 p-3 rounded ${isLowest ? "bg-green-100/70 text-green-800":"bg-blue-50/70 text-blue-800"}">
                <p class="text-sm font-semibold">Total Price (Round ${round}${isLowest ? " - LOWEST" : ""})</p>
                <div id="total-price-${offer.id}" class="text-3xl font-extrabold">${formatCurrency(offer.totalPrice)}</div>
            </div>
            
            <h3 class="font-semibold mb-2 mt-4 text-gray-700">Items Breakdown</h3>
            <div class="item-row text-xs font-bold border-b-2 border-gray-200 pb-1 mb-1">
                <span class="text-left flex-grow">Description</span>
                <span class="text-right w-20">Unit Price</span>
                <span class="text-right w-20">Subtotal</span>
                <span class="w-5"></span> 
            </div>
            <ul class="list-none p-0">${itemsList}</ul>
            <button onclick="addRow('${offer.id}', ${round})" class="btn ghost text-xs mt-3 py-1 px-2 border-dashed">‚ûï Add Item</button>
            
            <h3 class="font-semibold mt-6 mb-2 text-gray-700 border-t pt-3">Terms</h3>
            <p class="flex justify-between items-center mb-2 text-sm"><b>Payment:</b><select class="term-select" onchange="handleTermChange(event, '${offer.id}', 'payment', ${round})">${createSelectOptions(PAYMENT_OPTIONS, offer.terms.payment)}</select></p>
            <p class="flex justify-between items-center mb-2 text-sm"><b>Delivery:</b><select class="term-select" onchange="handleTermChange(event, '${offer.id}', 'delivery', ${round})">${createSelectOptions(DELIVERY_OPTIONS, offer.terms.delivery)}</select></p>
            <p class="mb-1 mt-4 text-sm"><b>Notes:</b></p>
            <textarea class="term-textarea" onblur="handleTermChange(event, '${offer.id}', 'notes', ${round})">${offer.terms.notes}</textarea>
        </div>
    `;
};

const renderOffers = () => {
    const round1Container = document.getElementById("offersContainerRound1");
    const round2Container = document.getElementById("offersContainerRound2");
    const initialPrompt = document.getElementById("initialPrompt");
    const round1Title = document.getElementById("round1Title");
    const round2Title = document.getElementById("round2Title");
    
    if (offersData.round1Offers.length === 0 && offersData.round2Offers.length === 0) { 
        round1Container.innerHTML = ""; 
        round2Container.innerHTML = "";
        initialPrompt.style.display = "block";
        round1Title.style.display = "none";
        round2Title.style.display = "none";
        document.getElementById('compareBtnRound2').disabled = true;
        return; 
    }
    
    initialPrompt.style.display = "none";

    // Render Round 1
    if (offersData.round1Offers.length > 0) {
        round1Title.style.display = "block";
        round1Container.innerHTML = offersData.round1Offers.map(o => renderOfferCard(o, 1)).join("");
        document.getElementById('compareBtnRound2').disabled = (attachedFiles.round2.length === 0);
    } else {
         round1Title.style.display = "none";
         round1Container.innerHTML = "";
    }

    // Render Round 2
    if (offersData.round2Offers.length > 0) {
        round2Title.style.display = "block";
        round2Container.innerHTML = offersData.round2Offers.map(o => renderOfferCard(o, 2)).join("");
    } else {
        round2Title.style.display = "none";
        round2Container.innerHTML = "";
    }
};

/*** UI Management Functions (Original Logic - not changed as per strict instructions) ***/

const getOfferById = (offerId, round) => {
    return offersData[`round${round}Offers`].find(o => o.id === offerId);
};

const recalculateTotal = (offer, round) => {
    offer.totalPrice = offer.items.reduce((sum, item) => sum + Number(item.subtotalPrice || 0), 0);
    renderOffers();
};

window.handlePriceChange = (event, offerId, itemIndex, round) => {
    const target = event.target;
    const newPrice = parseFlexibleCurrency(target.textContent);
    const offer = getOfferById(offerId, round);
    
    if (offer && offer.items[itemIndex]) {
        offer.items[itemIndex].subtotalPrice = newPrice;
        if (offer.items[itemIndex].quantity > 0) offer.items[itemIndex].unitPrice = newPrice / offer.items[itemIndex].quantity;
    }
    // Update the displayed text back to formatted currency after parsing
    target.textContent = formatCurrency(newPrice);
    recalculateTotal(offer, round);
};

window.handleItemDescriptionChange = (event, offerId, itemIndex, round) => {
    const offer = getOfferById(offerId, round);
    if (offer && offer.items[itemIndex]) {
        offer.items[itemIndex].description = event.target.textContent;
    }
};

window.handleTermChange = (event, offerId, termName, round) => {
    const offer = getOfferById(offerId, round);
    // Use value for selects/textareas, textContent for contenteditable
    const value = event.target.tagName === 'SELECT' || event.target.tagName === 'TEXTAREA' 
        ? event.target.value 
        : event.target.textContent;

    if (offer && offer.terms) offer.terms[termName] = value;
};

window.addRow = (offerId, round) => {
    const offer = getOfferById(offerId, round);
    if (offer) {
        const isPlaceholder = offer.items.length === 1 && (offer.items[0].description.includes('No valid item rows') || offer.items[0].description.includes('No items remaining'));
        if (isPlaceholder) {
            offer.items = [{ description: 'New Manual Item', unitPrice: 0, quantity: 1, subtotalPrice: 0 }];
        } else {
            offer.items.push({ 
                description: 'New Manual Item', 
                unitPrice: 0, 
                quantity: 1, 
                subtotalPrice: 0 
            });
        }
        recalculateTotal(offer, round);
    }
};

window.deleteRow = (offerId, itemIndex, round) => {
    const offer = getOfferById(offerId, round);
    if (offer) {
        offer.items.splice(itemIndex, 1);
        if (offer.items.length === 0) {
            offer.items.push({ description: 'No items remaining. Add a new one.', unitPrice: 0, quantity: 1, subtotalPrice: 0 });
        }
        recalculateTotal(offer, round);
    }
};

// --- loadExtractedData function (re-added for completeness, uses original parser) ---
window.loadExtractedData = async (round) => {
    const roundKey = `round${round}`;
    const filesToProcess = attachedFiles[roundKey];
    
    if (filesToProcess.length === 0) { alert(`Please attach files for Round ${round} first!`); return; }
    
    const buttonId = `compareBtn${roundKey.charAt(0).toUpperCase() + roundKey.slice(1)}`;
    const compareBtn = document.getElementById(buttonId);
    compareBtn.disabled = true;
    compareBtn.textContent = "Processing...";
    
    const results = [];
    for (let i=0;i<filesToProcess.length;i++) {
        const fileObj = filesToProcess[i];
        const f = fileObj.file;
        let rows = [];
        let extractionFailed = false;

        if (f.type && f.type.includes('pdf')) {
            try {
                // Using the user's provided (coordinate-based) PDF parser
                rows = await extractDataFromPDF(f, fileObj.searchTerm); 
            } catch (e) {
                console.warn(`PDF automatic parsing failed for Round ${round}`, e);
                rows = [{ description: `Automatic PDF parsing failed.`, price: 0 }];
                extractionFailed = true;
            }
        } else if (/\.(xlsx|xls)$/i.test(f.name)) {
            try {
                rows = await extractDataFromExcel(f, fileObj.startingRow, fileObj.searchTerm);
            } catch (e) {
                console.warn(`Excel read failed for Round ${round}`, e);
                rows = [{ description: `Error reading Excel: ${e.message || 'Check console.'}`, price: 0 }];
                extractionFailed = true;
            }
        } else {
            rows = [{ description: `File type not supported: ${f.name}`, price: 0 }];
            extractionFailed = true;
        }
        
        results.push({ file: fileObj, rows });
    }

    offersData[roundKey + 'Offers'] = results.map((r, idx) => generateOfferFromFile(r.file, idx, r.rows, round));
    renderOffers();
    
    compareBtn.disabled = false;
    compareBtn.textContent = `Extract Round ${round} Data`;
};


// --- Updated Excel Logic for Styling and Borders ---

const EXCEL_BORDER = {
    top: { style: "thin", color: { rgb: "000000" } },
    bottom: { style: "thin", color: { rgb: "000000" } },
    left: { style: "thin", color: { rgb: "000000" } },
    right: { style: "thin", color: { rgb: "000000" } }
};

const STYLES = {
    Header: {
        fill: { fgColor: { rgb: "4472C4" } }, // Dark Blue Background
        font: { color: { rgb: "FFFFFF" }, bold: true },
        border: EXCEL_BORDER,
        alignment: { horizontal: "center" }
    },
    DataRow: {
        fill: { fgColor: { rgb: "F2F2F2" } }, // Light Grey Background
        border: EXCEL_BORDER,
        alignment: { horizontal: "left" }
    },
    PriceRow: {
        fill: { fgColor: { rgb: "F2F2F2" } },
        border: EXCEL_BORDER,
        alignment: { horizontal: "right" },
        numFmt: "#,##0.00"
    }
};

const createComparisonTableData = (roundOffers, roundNumber, masterItemList) => {
    if (roundOffers.length === 0) return [];
    let table = [];

    // Header Row
    let headers = [
        { v: `Round ${roundNumber} Items`, s: STYLES.Header },
        { v: "Qty", s: STYLES.Header }
    ];
    roundOffers.forEach(o => headers.push({ v: o.supplier, s: STYLES.Header }));
    table.push(headers);

    // Data Rows
    masterItemList.forEach(mItem => {
        let row = [
            { v: mItem.description, s: STYLES.DataRow },
            { v: mItem.masterQuantity || 1, s: STYLES.DataRow }
        ];
        roundOffers.forEach(offer => {
            const item = offer.items.find(i => i.description.toLowerCase() === mItem.description.toLowerCase());
            row.push({ v: item ? item.subtotalPrice : 0, t: 'n', s: STYLES.PriceRow });
        });
        table.push(row);
    });

    // Totals Row
    let totalRow = [{ v: "GRAND TOTAL", s: STYLES.Header }, { v: "", s: STYLES.Header }];
    roundOffers.forEach(o => totalRow.push({ v: o.totalPrice, t: 'n', s: { ...STYLES.Header, alignment: { horizontal: "right" }, numFmt: "#,##0.00" } }));
    table.push(totalRow);

    return table;
};

function downloadExcel() {
    if (offersData.round1Offers.length === 0 && offersData.round2Offers.length === 0) {
        alert("No offers loaded to download."); return;
    }

    const wb = XLSX.utils.book_new();
    const offerTitle = document.getElementById('offerTitle').value || 'Comparison_Report';

    const allOffers = [...offersData.round1Offers, ...offersData.round2Offers];
    const items = {};
    allOffers.forEach(o => o.items.forEach(i => {
        items[i.description.toLowerCase()] = { description: i.description, masterQuantity: i.quantity };
    }));
    const masterItemList = Object.values(items).sort((a,b) => a.description.localeCompare(b.description));

    let sheetData = [[{ v: `REPORT: ${offerTitle.toUpperCase()}`, s: { font: { bold: true, sz: 14, color: { rgb: "4472C4" } } } }], []];

    if (offersData.round1Offers.length > 0) {
        sheetData.push(...createComparisonTableData(offersData.round1Offers, 1, masterItemList));
    }
    
    sheetData.push([], []); // Vertical spacing

    if (offersData.round2Offers.length > 0) {
        sheetData.push(...createComparisonTableData(offersData.round2Offers, 2, masterItemList));
    }

    // Savings Summary Section
    sheetData.push([], [{ v: "SAVINGS SUMMARY", s: { font: { bold: true, sz: 12 } } }]);
    sheetData.push(["Category", "Type", "Value (EGP)", "Notes"].map(v => ({ v, s: STYLES.Header })));
    
    document.querySelectorAll('#savingsTable tbody tr').forEach(tr => {
        sheetData.push([
            { v: tr.children[0].textContent, s: STYLES.DataRow },
            { v: tr.children[1].textContent, s: STYLES.DataRow },
            { v: parseFlexibleCurrency(tr.children[2].textContent), t: 'n', s: STYLES.PriceRow },
            { v: tr.children[3].textContent, s: STYLES.DataRow }
        ]);
    });

    const ws = XLSX.utils.aoa_to_sheet(sheetData);
    ws['!cols'] = [{ wch: 40 }, { wch: 10 }, { wch: 20 }, { wch: 20 }, { wch: 20 }];
    
    XLSX.utils.book_append_sheet(wb, ws, "Comparison Report");
    XLSX.writeFile(wb, `${offerTitle.replace(/\s+/g, '_')}_Report.xlsx`);
}
</script>
</body>
</html>